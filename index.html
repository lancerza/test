<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Online TV Grid Player</title>
    <link rel="icon" href="data:;base64,=">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/controls.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #121212; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 95%; max-width: 1200px; margin: 20px auto; }
        .shaka-video-container { width: 100%; }
        video { width: 100%; }
        .channel-info { display: flex; align-items: center; justify-content: center; gap: 20px; margin-top: 20px; padding: 10px; background-color: #1e1e1e; border-radius: 12px; }
        .channel-info .logo { height: 50px; margin: 0; }
        .channel-name { font-size: 24px; font-weight: bold; color: #ffffff; margin: 0; }
        .channel-buttons { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; margin-top: 20px; }
        .channel-tile { background-color: #2a2a2e; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; text-decoration: none; cursor: pointer; transition: all 0.2s ease-in-out; border: 2px solid transparent; min-height: 120px; }
        .channel-tile:hover { transform: scale(1.05); background-color: #3c3c41; }
        .channel-tile.active { border-color: #1e90ff; background-color: #25395c; transform: scale(1.05); box-shadow: 0 0 20px rgba(30, 144, 255, 0.4); }
        .channel-tile img { width: 100%; max-height: 60px; object-fit: contain; margin-bottom: 10px; flex-grow: 1; }
        .channel-tile-name { font-size: 14px; color: #e0e0e0; text-align: center; font-weight: 500; }
        .spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .spinner { border: 8px solid #444; border-top: 8px solid #1e90ff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div data-shaka-player-container style="width: 100%; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);">
             <video id="video" autoplay></video>
        </div>
        <div id="channel-info" class="channel-info" style="display: none;">
            <img id="channel-logo" class="logo" src="" alt="Channel Logo"/>
            <h2 id="channel-name" class="channel-name"></h2>
        </div>
        <div id="channel-buttons-container" class="channel-buttons"></div>
    </div>
    <div id="loading-spinner" class="spinner-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>
    <script>
    let player, channels = {}, currentChannelId = null;
    const videoContainer = document.querySelector('[data-shaka-player-container]');
    const videoElement = document.getElementById('video');
    const channelButtonsContainer = document.getElementById('channel-buttons-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    const channelInfoContainer = document.getElementById('channel-info');
    const channelLogo = document.getElementById('channel-logo');
    const channelNameElement = document.getElementById('channel-name');

    function showLoading(show) { loadingSpinner.style.display = show ? 'flex' : 'none'; }
    function updateActiveButton() {
        const tiles = channelButtonsContainer.querySelectorAll('.channel-tile');
        tiles.forEach(tile => tile.classList.toggle('active', tile.dataset.channelId === currentChannelId));
    }
    function createChannelButtons() {
        channelButtonsContainer.innerHTML = '';
        for (const channelId in channels) {
            const channel = channels[channelId];
            const tile = document.createElement('a');
            tile.className = 'channel-tile';
            tile.dataset.channelId = channelId;
            tile.onclick = () => {
                loadChannel(channelId);
                videoContainer.scrollIntoView({ behavior: 'smooth' });
            };
            const logoImg = document.createElement('img');
            logoImg.src = channel.logo;
            logoImg.alt = channel.name;
            const nameSpan = document.createElement('span');
            nameSpan.className = 'channel-tile-name';
            nameSpan.innerText = channel.name;
            tile.appendChild(logoImg);
            tile.appendChild(nameSpan);
            channelButtonsContainer.appendChild(tile);
        }
    }
    async function loadChannel(channelId) {
        if (!channels[channelId]) return;
        showLoading(true);
        currentChannelId = channelId;
        const channel = channels[channelId];
        channelInfoContainer.style.display = 'flex';
        channelLogo.src = channel.logo;
        channelLogo.alt = `Logo for ${channel.name}`;
        channelNameElement.innerText = channel.name;
        updateActiveButton();
        const [keyId, key] = channel.license_key.split(':');
        player.configure({ drm: { clearKeys: { [keyId]: key } } });
        try {
            await player.load(channel.url);
            localStorage.setItem('lastChannelId', channelId);
        } catch (error) {
            console.error(`Error loading channel ${channel.name}:`, error);
            channelNameElement.innerText = `Error loading channel`;
            channelLogo.src = '';
        } finally {
            showLoading(false);
        }
    }
    async function init() {
        if (!shaka.Player.isBrowserSupported()) {
            alert("Sorry, your browser is not supported.");
            return;
        }
        showLoading(true);
        try {
            const response = await fetch('channels.json');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            channels = await response.json();
        } catch (e) {
            alert("Fatal Error: Could not load channel data.");
            showLoading(false);
            return;
        }
        player = new shaka.Player();
        await player.attach(videoElement);
        
        player.configure({
            ui: {
                stream_type: 'live',
                controlPanelElements: [
                    'play_pause',
                    'time_and_duration',
                    'spacer',
                    'mute',
                    'volume',
                    'fullscreen',
                    'overflow_menu'
                ]
            }
        });

        player.addEventListener('error', e => console.error("Shaka Player Error:", e.detail));
        
        const savedVolume = localStorage.getItem('playerVolume');
        const savedMuted = localStorage.getItem('playerMuted');
        if (savedVolume) videoElement.volume = parseFloat(savedVolume);
        if (savedMuted) videoElement.muted = savedMuted === 'true';
        videoElement.addEventListener('volumechange', () => {
            localStorage.setItem('playerVolume', videoElement.volume);
            localStorage.setItem('playerMuted', videoElement.muted);
        });
        createChannelButtons();
        const lastChannelId = localStorage.getItem('lastChannelId');
        const firstChannelId = Object.keys(channels)[0];
        const channelToLoad = lastChannelId && channels[lastChannelId] ? lastChannelId : firstChannelId;
        if (channelToLoad) {
            await loadChannel(channelToLoad);
        } else {
            showLoading(false);
        }
    }
    document.addEventListener("DOMContentLoaded", init);
    </script>
</body>
</html>
