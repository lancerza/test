<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3BB Online TV - V2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.min.js"></script>
    <style>
        /* --- Base Styles --- */
        body {
            margin: 0;
            padding: 0;
            background: #121212; /* Darker background */
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1000px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        /* --- Video Player --- */
        video {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            background-color: #000;
        }

        /* --- Channel Controls --- */
        .channel-controls {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #1e1e1e;
            border-radius: 12px;
        }

        .logo {
            height: 50px;
            margin-bottom: 20px;
        }

        .channel-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .channel-buttons button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid transparent;
            border-radius: 8px;
            background: #333;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .channel-buttons button:hover {
            background-color: #444;
            transform: translateY(-2px);
        }

        .channel-buttons button.active {
            background-color: #1e90ff;
            color: white;
            border-color: #64b5f6;
            box-shadow: 0 0 15px rgba(30, 144, 255, 0.5);
        }
        
        /* --- EPG Box --- */
        .epg-box {
            margin-top: 20px;
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            font-size: 16px;
            line-height: 1.6;
            text-align: center;
        }

        /* --- Loading Spinner --- */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .spinner {
            border: 8px solid #444;
            border-top: 8px solid #1e90ff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="channel-controls">
            <img id="channel-logo" class="logo" src="" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ä‡πà‡∏≠‡∏á"/>
            <div id="channel-buttons-container" class="channel-buttons">
                </div>
        </div>

        <video id="video" autoplay controls poster="https://via.placeholder.com/1000x562/000000/FFFFFF?text=‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏ä‡∏°"></video>

        <div class="epg-box" id="epg-box">
            <strong>EPG:</strong> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≠‡∏á...
        </div>
    </div>

    <div id="loading-spinner" class="spinner-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <script>
    // --- GLOBAL VARIABLES ---
    let player;
    let channels = {};
    let currentChannelId = null;

    // --- DOM ELEMENTS ---
    const videoElement = document.getElementById('video');
    const channelLogo = document.getElementById('channel-logo');
    const epgBox = document.getElementById('epg-box');
    const channelButtonsContainer = document.getElementById('channel-buttons-container');
    const loadingSpinner = document.getElementById('loading-spinner');

    /**
     * Toggles the visibility of the loading spinner.
     * @param {boolean} show - True to show, false to hide.
     */
    function showLoading(show) {
        loadingSpinner.style.display = show ? 'flex' : 'none';
    }
    
    /**
     * Updates the active state of channel buttons.
     */
    function updateActiveButton() {
        const buttons = channelButtonsContainer.querySelectorAll('button');
        buttons.forEach(button => {
            button.classList.toggle('active', button.dataset.channelId === currentChannelId);
        });
    }

    /**
     * Creates channel buttons dynamically from the channels data.
     */
    function createChannelButtons() {
        channelButtonsContainer.innerHTML = ''; // Clear existing buttons
        for (const channelId in channels) {
            const channel = channels[channelId];
            const button = document.createElement('button');
            button.innerText = channel.name;
            button.dataset.channelId = channelId;
            button.onclick = () => loadChannel(channelId);
            channelButtonsContainer.appendChild(button);
        }
    }

    /**
     * Loads a selected channel, configures DRM, and updates the UI.
     * @param {string} channelId - The ID of the channel to load.
     */
    async function loadChannel(channelId) {
        if (!channels[channelId]) {
            console.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≠‡∏á:", channelId);
            return;
        }

        showLoading(true);
        currentChannelId = channelId;
        const channel = channels[channelId];

        // 1. Update UI
        channelLogo.src = channel.logo;
        channelLogo.alt = `‡πÇ‡∏•‡πÇ‡∏Å‡πâ ${channel.name}`;
        epgBox.innerHTML = `<strong>üì∫ ${channel.name}</strong><br><strong>EPG:</strong> ${channel.epg}`;
        updateActiveButton();

        // 2. Configure DRM
        const [keyId, key] = channel.license_key.split(':');
        player.configure({
            drm: { clearKeys: { [keyId]: key } }
        });

        // 3. Load Manifest
        try {
            await player.load(channel.url);
            console.log("‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏ä‡πà‡∏≠‡∏á:", channel.name);
            localStorage.setItem('lastChannelId', channelId); // Save last successfully played channel
        } catch (error) {
            console.error(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πà‡∏≠‡∏á ${channel.name}:`, error);
            epgBox.innerHTML = `<strong>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πà‡∏≠‡∏á ${channel.name}</strong>`;
        } finally {
            showLoading(false);
        }
    }

    /**
     * Main initialization function for the application.
     */
    async function init() {
        if (!shaka.Player.isBrowserSupported()) {
            alert("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏∞");
            return;
        }
        
        showLoading(true);

        // 1. Fetch channel data
        try {
            const response = await fetch('channels.json');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            channels = await response.json();
        } catch (e) {
            console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå channels.json:", e);
            epgBox.innerHTML = '<strong>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏î‡πâ</strong>';
            showLoading(false);
            return;
        }
        
        // 2. Initialize Player
        player = new shaka.Player(videoElement);
        player.addEventListener('error', (e) => {
            console.error("Shaka Player Error:", e.detail);
        });
        
        // 3. Restore and save volume settings
        const savedVolume = localStorage.getItem('playerVolume');
        const savedMuted = localStorage.getItem('playerMuted');
        if (savedVolume) videoElement.volume = parseFloat(savedVolume);
        if (savedMuted) videoElement.muted = savedMuted === 'true';

        videoElement.addEventListener('volumechange', () => {
            localStorage.setItem('playerVolume', videoElement.volume);
            localStorage.setItem('playerMuted', videoElement.muted);
        });
        
        // 4. Create UI and load initial channel
        createChannelButtons();
        
        const lastChannelId = localStorage.getItem('lastChannelId');
        const firstChannelId = Object.keys(channels)[0];
        const channelToLoad = lastChannelId && channels[lastChannelId] ? lastChannelId : firstChannelId;

        if (channelToLoad) {
            await loadChannel(channelToLoad);
        } else {
            epgBox.innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
            showLoading(false);
        }
    }

    // Start the application when the DOM is ready
    document.addEventListener("DOMContentLoaded", init);
    </script>
</body>
</html>
